<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Keyboard</title>
    <link rel="stylesheet" href="./style.css" />
    <button id="start" style="float: left">Start</button>
    <div id="playContainer">
      <button
        id="playBTN"
        onclick="playMelody(myMelody,snappedMelody, snapped); switchButtons(true)"
        type="button"
      >
        Play
      </button>
    </div>
    <div id="icon">
      <button
        type="button"
        value="piano"
        onclick="getIcon(this.value)"
        style="width: 100%"
      >
        Piano
      </button>
      <button
        type="button"
        value="guitar"
        onclick="getIcon(this.value)"
        style="width: 100%"
      >
        Guitar
      </button>
      <button
        type="button"
        value="bells"
        onclick="getIcon(this.value)"
        style="width: 100%"
      >
        Bells
      </button>
    </div>
    <button id="Vconnect">Vertical Snap</button>
    <button id="Hconnect">Horizontal Snap</button>
    <button id="Unsnap">Disconnect</button>
    <!-- <button id="disconnectTop">UnSnap Top</button>
    <button id="disconnectBottom">UnSnap Bottom</button>
    <button id="disconnectRight">UnSnap Right</button>
    <button id="disconnectLeft">UnSnap Left</button> -->
  </head>
  <body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/p5@1.5.0/lib/p5.js"></script>
    <script src="shake.js"></script>
    <script src="Note.js"></script>
    <script src="Track.js"></script>
    <script src="functions.js"></script>
    <script src="script.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        var socket = io();
        var shakeEvent = new Shake({threshold: 15, timeout: 1000});
        shakeEvent.start();
        if ('DeviceMotionEvent' in window) {
          // Device motion events are supported
          console.log('Device motion events are supported');
        } else {
          // Device motion events are not supported
          console.log('Device motion events are not supported');
        }

        document.getElementById('Vconnect').addEventListener('click',function(){
          socket.emit('Vsnap',{melody:getMelody(snapped),id:socket.id,songSection:getSongSection()});
        });
        document.getElementById('Hconnect').addEventListener('click',function(){
          socket.emit('Hsnap',{melody:getMelody(snapped),id:socket.id,songSection:getSongSection()});
        });
        // document.getElementById('disconnectTop').addEventListener('click',function(){
        //   if (partners.top != null){
        //     socket.emit('Unsnap', {recipient: partners.top,id:socket.id,side:'bottom'});
        //   }
        // });
        // document.getElementById('disconnectBottom').addEventListener('click',function(){
        //   if (partners.bottom != null){
        //     socket.emit('Unsnap', {recipient: partners.bottom,id:socket.id,side:'top'});
        //   }
        // });
        // document.getElementById('disconnectRight').addEventListener('click',function(){
        //   if (partners.right != null){
        //     socket.emit('Unsnap', {recipient: partners.right,id:socket.id,side:'left'});
        //   }
        // });
        // document.getElementById('disconnectLeft').addEventListener('click',function(){
        //   if (partners.left != null){
        //     socket.emit('Unsnap', {recipient: partners.left,id:socket.id,side:'right'});
        //   }
        // });
        document.getElementById('Unsnap').addEventListener('click',()=>{
          socket.emit('Reset');
        })
        window.addEventListener('shake', function(){
          console.log("Shake detected");
          socket.emit('Reset');
        },false);
        document.getElementById('Unsnap').addEventListener('click',()=>{
          socket.emit('Reset');
        });

        socket.on('Reset',function(){
          update(0, new Melody([]));
          partners = {top:null,bottom:null,right:null,left:null};
          snapped = false;
        });
        socket.on('Vsnap',function(data){
          let {Melodies, otherSection, isTop} = data;
          let diff = 0;
          let differences = [0,0];
          if (otherSection > mySection){
            diff = otherSection - mySection;
            setSongSection(otherSection);
            if (isTop) {
              differences = [diff,0];
            }
            else {
              differences = [0,diff];
            }
          }
          else {
            diff = mySection - otherSection;
            if (isTop){
              differences = [0, diff];
            }
            else {
              differences = [diff,0];
            }
          }
          snappedMelody = constructMelody(Melodies, false, differences);
          snapped = true;
          for (var side in partners) {
            if (partners[side] != null) {
              socket.emit('Update', {sender: socket.id, recipient: partners[side], partner: side, 
                newSection:mySection, newMelody:snappedMelody, senderMelody:myMelody});
            };
          }
        });
        socket.on('Hsnap',function(data){
          let {Melodies, otherSection, isLeft} = data;
          let diff = 0;
          let differences;
          let oldSection = mySection;
          if (!isLeft){
            setSongSection(otherSection+1);
            diff = mySection - oldSection;
            differences = [0,diff];
            // call some function to propagate the change to its neighbours
          }
          else {
            diff = mySection + 1 - otherSection;
            differences = [0,diff];
          }
          
          snappedMelody = constructMelody(Melodies, true, differences);
          snapped = true;
        });
        socket.on('Top',function(partnerID){
          partners.top = partnerID;
        });
        socket.on('Bottom',function(partnerID){
          partners.bottom = partnerID;
        });
        socket.on('Left',function(partnerID){
          partners.left = partnerID;
        });
        socket.on('Right',function(partnerID){
          partners.right = partnerID;
        });
        socket.on('Update', function(data){
          let {senderID, newSection, newMelody} = data;
          update(newSection, newMelody);
          // send back to all partners except the one that it was received from
          for (var side in partners) {
            if (partners[side] != null && partners[side] != senderID) {
              socket.emit('Update', {recipient: partners[side], partner: side, 
                newSection:mySection, newMelody:snappedMelody});
            };
          }
        })
        socket.on('Unsnap', function(data){
          let {formerPartner, mySide} = data;
          var nullPartners = 0;
          for (var side in partners){
            if (partners[side] == formerPartner){
              partners[side] = null;
            }
            if (partners[side] == null){
              nullPartners += 1;
            }
          }
          if (nullPartners == 4){
            snapped = false;
          }
          socket.emit('Resnap', {id:socket.id, partners:partners, melody:myMelody, side:mySide,section:mySection,total:snappedMelody.numSections})
        });
        socket.on('Resnap', function(side){
          socket.emit('Resnap', {id:socket.id, partners:partners, melody:myMelody, side:side,section:mySection,total:snappedMelody.numSections})
        });
        socket.on('Remove',function(data){
          console.log("Got here")
          let {melody,section} = data;
          let melodyToRemove = shiftMelody(reconstructMelody(melody),section);
          snappedMelody = snappedMelody.removeMelody(melodyToRemove);
          snappedMelody.numSections -= 1;
          console.log(snappedMelody);
        });
    </script>
  </body>
</html>
